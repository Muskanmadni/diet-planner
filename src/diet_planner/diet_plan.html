<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diet Plan - NutriGuide</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ---- ALL ORIGINAL STYLES (unchanged) ---- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif
        }

        :root {
            --primary: #4CAF50;
            --primary-dark: #388E3C;
            --secondary: #2196F3;
            --accent: #FF9800;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --light-gray: #e9ecef;
            --border: #dee2e6
        }

        body {
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            min-height: 100vh
        }

        header {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
            color: #fff;
            padding: .8rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, .1);
            position: sticky;
            top: 0;
            z-index: 1000
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .logo {
            display: flex;
            align-items: center;
            font-size: 1.5rem;
            font-weight: bold
        }

        .logo img {
            height: 30px;
            margin-right: 10px
        }

        nav ul {
            display: flex;
            list-style: none
        }

        nav ul li {
            margin-left: 1.5rem
        }

        nav ul li a {
            color: #fff;
            text-decoration: none;
            padding: .5rem 1rem;
            border-radius: 4px;
            transition: background .3s;
            display: flex;
            align-items: center
        }

        nav ul li a:hover,
        nav ul li a.active {
            background: rgba(255, 255, 255, .2)
        }

        nav ul li a i {
            margin-right: 8px
        }

        .user-actions button {
            background: rgba(255, 255, 255, .2);
            color: #fff;
            border: none;
            padding: .5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background .3s
        }

        .user-actions button:hover {
            background: rgba(255, 255, 255, .3)
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 20px
        }

        .section-title {
            text-align: center;
            margin-bottom: 2rem;
            color: var(--dark);
            position: relative;
            padding-bottom: 1rem
        }

        .section-title:after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: var(--primary)
        }

        .meal-planner-container {
            background: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .05)
        }

        .meal-plan-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem
        }

        .meal-plan-title {
            font-size: 1.8rem;
            color: var(--dark)
        }

        .meal-plan-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--primary);
            color: #fff;
            padding: .6rem 1.2rem;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background .3s, transform .2s;
            gap: 8px
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px)
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--primary);
            color: var(--primary)
        }

        .btn-outline:hover {
            background: var(--primary);
            color: #fff
        }

        .week-navigation {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px
        }

        .week-navigation button {
            background: var(--light-gray);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem
        }

        .week-navigation button:hover {
            background: var(--primary);
            color: #fff
        }

        .current-week {
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
            text-align: center
        }

        .days-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            gap: 5px
        }

        .day-tab {
            padding: .8rem 1.2rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all .3s;
            white-space: nowrap
        }

        .day-tab:hover {
            background: var(--light)
        }

        .day-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: #fff;
            font-weight: bold
        }

        .diet-plan-container {
            display: none;
            margin-top: 1.5rem
        }

        .day-plan-container {
            display: none;
            margin-bottom: 2rem
        }

        .day-plan-container.active {
            display: block
        }

        .day-plan-header {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
            text-align: center
        }

        .meals-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem
        }

        .meal-box {
            background: #fff;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, .05)
        }

        .meal-header {
            background: var(--primary);
            color: #fff;
            padding: .8rem;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem
        }

        .meal-time {
            font-weight: 600
        }

        .meal-icon {
            font-size: 1.2rem
        }

        .meal-content {
            padding: .5rem 0
        }

        .meal-item {
            display: block;
            padding: .5rem 0;
            border-bottom: 1px solid var(--light-gray)
        }

        .meal-item:last-child {
            border-bottom: none
        }

        .meal-item-name {
            font-weight: 500
        }

        .meal-item-calories {
            color: var(--gray)
        }

        .add-meal-btn {
            display: inline-block;
            margin-top: 1rem;
            color: var(--primary);
            padding: .5rem 1rem;
            border: 1px solid var(--primary);
            border-radius: 5px;
            text-decoration: none;
            font-weight: 500;
            transition: background .3s
        }

        .add-meal-btn:hover {
            background: #e8f5e9
        }

        .no-plan-message {
            text-align: center;
            padding: 2rem;
            color: var(--gray);
            font-style: italic
        }

        .nutrition-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 2rem
        }

        .nutrient-card {
            background: #fff;
            border-radius: 8px;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .08);
            border: 1px solid var(--border)
        }

        .nutrient-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary);
            margin: .5rem 0
        }

        .nutrient-label {
            color: var(--gray);
            font-size: .9rem
        }

        .progress-bar {
            height: 8px;
            background: var(--light-gray);
            border-radius: 4px;
            margin-top: .5rem;
            overflow: hidden
        }

        .progress {
            height: 100%;
            background: var(--primary);
            border-radius: 4px
        }

        .meal-plan-generator {
            background: #fff;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, .05);
            margin-top: 2rem
        }

        .form-group {
            margin-bottom: 1.5rem
        }

        .form-group label {
            display: block;
            margin-bottom: .5rem;
            font-weight: 600;
            color: var(--dark)
        }

        .form-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap
        }

        .form-col {
            flex: 1;
            min-width: 200px
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: .75rem;
            border: 1px solid var(--border);
            border-radius: 5px;
            font-size: 1rem
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(76, 175, 80, .2)
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, .5);
            z-index: 2000;
            align-items: center;
            justify-content: center
        }

        .modal-content {
            background: #fff;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--dark)
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer
        }

        .modal-body {
            padding: 1.5rem
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px
        }

        .subscription-status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center
        }

        .status-active {
            background: #e8f5e9;
            color: #2e7d32
        }

        .status-inactive {
            background: #ffebee;
            color: #c62828
        }

        .nutrition-details {
            background: #fff;
            border-radius: 8px;
            padding: 1.2rem;
            margin-top: 1.5rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, .08);
            border: 1px solid var(--border)
        }

        .nutrition-title {
            text-align: center;
            margin-bottom: 1rem;
            color: var(--dark);
            font-size: 1.2rem
        }

        .nutrition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem
        }

        .nutrition-item {
            text-align: center;
            padding: .8rem;
            border-radius: 5px;
            background: #f8f9fa
        }

        .nutrition-value {
            font-size: 1.4rem;
            font-weight: bold;
            color: var(--primary)
        }

        .nutrition-label {
            font-size: .8rem;
            color: var(--gray)
        }

        .daily-log {
            margin-top: 2rem
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem
        }

        .log-entries {
            max-height: 300px;
            overflow-y: auto
        }

        .log-entry {
            display: flex;
            justify-content: space-between;
            padding: .8rem;
            border-bottom: 1px solid var(--border)
        }

        .log-entry:last-child {
            border-bottom: none
        }

        .simple-plan-content pre {
            white-space: pre-wrap;
            font-family: inherit
        }

        .meal-list {
            list-style: disc;
            margin-left: 1.5rem
        }

        .meal-item {
            display: flex;
            justify-content: space-between
        }

        .meal-name {
            font-weight: 500
        }

        .meal-calories {
            color: var(--gray);
            font-style: italic
        }

        @media(max-width:992px) {
            .meals-container {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr))
            }
        }

        @media(max-width:768px) {
            .meal-plan-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem
            }

            .meal-plan-actions {
                flex-direction: row;
                flex-wrap: wrap;
                width: auto;
                justify-content: flex-start
            }

            .form-row {
                flex-direction: column
            }

            .form-col {
                min-width: auto
            }

            .header-container {
                flex-direction: column;
                gap: 1rem
            }

            nav ul {
                flex-wrap: wrap;
                justify-content: center
            }

            nav ul li {
                margin: .2rem .5rem
            }

            .days-tabs {
                overflow-x: auto
            }

            .nutrition-summary {
                grid-template-columns: 1fr
            }

            .log-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem
            }

            .btn {
                padding: .6rem 1.2rem;
                font-size: .9rem
            }
        }

        @media(max-width:576px) {
            .container {
                padding: 0 10px
            }

            .meal-plan-title {
                font-size: 1.5rem
            }

            .week-navigation {
                flex-direction: column;
                gap: .5rem
            }

            .current-week {
                text-align: center
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="header-container">
            <div class="logo"><img src="/static/images/logo.png" alt="NutriGuide Logo"></div>
            <nav>
                <ul>
                    <li><a href="/"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="/diet-plan" class="active"><i class="fas fa-calendar-alt"></i> Meal Plans</a></li>
                    <li><a href="/dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="/chatbot"><i class="fas fa-comment-dots"></i> Nutritionist</a></li>
                    <li><a href="/profile"><i class="fas fa-user"></i> Profile</a></li>
                    <li><a href="/settings"><i class="fas fa-cog"></i> Settings</a></li>
                </ul>
            </nav>
            <div class="user-actions"><button id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button></div>
        </div>
    </header>

    <div class="container">
        <div class="meal-planner-container">

            <!-- ==== GENERATOR ==== -->
            <div class="meal-plan-generator">
                <h2 class="section-title">Generate New Meal Plan</h2>
                <div id="current-subscription" class="subscription-status status-inactive">Loading subscription
                    status...</div>

                <form id="generate-plan-form">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="goal">Goal</label>
                                <select id="goal" name="goal">
                                    <option value="lose">Lose Weight</option>
                                    <option value="gain">Gain Weight</option>
                                    <option value="maintain" selected>Maintain Weight</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="calories">Daily Calories</label>
                                <input type="number" id="calories" name="calories" value="2200" min="1200" max="4000">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="diet-type">Diet Type</label>
                                <select id="diet-type" name="dietType">
                                    <option value="balanced" selected>Balanced</option>
                                    <option value="low-carb">Low Carb</option>
                                    <option value="high-protein">High Protein</option>
                                    <option value="vegetarian">Vegetarian</option>
                                    <option value="keto">Keto</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-row" id="premiumFeatures" style="display:none;">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="allergies">Food Allergies/Restrictions</label>
                                <input type="text" id="allergies" name="allergies"
                                    placeholder="e.g., nuts, dairy, gluten">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="preferences">Medical Conditions</label>
                                <input type="text" id="preferences" name="preferences"
                                    placeholder="e.g., diabetes, hypertension">
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn" id="generate-plan-btn-form" style="margin-top:1rem;">
                        <i class="fas fa-magic"></i> Generate Custom Meal Plan
                    </button>
                </form>
            </div>

            <!-- ==== PLAN DISPLAY ==== -->
            <div id="diet-plan-container" style="display:none; margin-top:2rem;">
                <div class="meal-plan-header">
                    <h1 class="meal-plan-title">Your Generated Meal Plan</h1>
                    <div class="meal-plan-actions">
                        <button class="btn btn-outline" id="save-plan-btn"><i class="fas fa-save"></i> Save
                            Plan</button>
                        <button class="btn btn-outline" id="download-pdf-btn"><i class="fas fa-file-pdf"></i> Download
                            PDF</button>
                    </div>
                </div>

                <!-- Simple text / list view -->
                <div class="simple-diet-plan"
                    style="background:#fff;border-radius:10px;padding:1.5rem;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-top:1.5rem;">
                    <div id="simple-plan-display"
                        style="min-height:400px;max-height:500px;overflow-y:auto;padding:10px;border:1px solid #eee;border-radius:8px;">
                        <div class="no-plan-message">No meal plan generated yet. Click “Generate New Plan” to create
                            your personalized meal plan.</div>
                    </div>
                </div>
            </div>

            <!-- ==== NUTRITION SUMMARY ==== -->
            <div class="nutrition-summary">
                <div class="nutrient-card">
                    <div class="nutrient-label">Calories</div>
                    <div class="nutrient-value" data-goal="2200">2,200</div>
                    <div class="progress-bar">
                        <div class="progress" style="width:100%"></div>
                    </div>
                    <div>Goal: <span class="goal-cal">2,200</span></div>
                </div>
                <div class="nutrient-card">
                    <div class="nutrient-label">Protein</div>
                    <div class="nutrient-value" data-goal="140">150g</div>
                    <div class="progress-bar">
                        <div class="progress" style="width:107%"></div>
                    </div>
                    <div>Goal: <span class="goal-pro">140g</span></div>
                </div>
                <div class="nutrient-card">
                    <div class="nutrient-label">Carbs</div>
                    <div class="nutrient-value" data-goal="300">280g</div>
                    <div class="progress-bar">
                        <div class="progress" style="width:93%"></div>
                    </div>
                    <div>Goal: <span class="goal-carb">300g</span></div>
                </div>
                <div class="nutrient-card">
                    <div class="nutrient-label">Fat</div>
                    <div class="nutrient-value" data-goal="90">85g</div>
                    <div class="progress-bar">
                        <div class="progress" style="width:94%"></div>
                    </div>
                    <div>Goal: <span class="goal-fat">90g</span></div>
                </div>
            </div>

            <!-- ==== DETAILED BREAKDOWN ==== -->
            <div class="nutrition-details">
                <h3 class="nutrition-title">Nutrition Breakdown</h3>
                <div class="nutrition-grid">
                    <div class="nutrition-item">
                        <div class="nutrition-value">40%</div>
                        <div class="nutrition-label">Carbs</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value">30%</div>
                        <div class="nutrition-label">Protein</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value">30%</div>
                        <div class="nutrition-label">Fat</div>
                    </div>
                    <div class="nutrition-item">
                        <div class="nutrition-value">2,500</div>
                        <div class="nutrition-label">H2O (ml)</div>
                    </div>
                </div>
            </div>

            <!-- ==== DAILY LOG ==== -->
            <div class="daily-log">
                <div class="log-header">
                    <h3>Daily Nutrition Log</h3>
                    <button class="btn btn-outline" id="log-meal-btn"><i class="fas fa-plus"></i> Log Meal</button>
                </div>
                <div class="log-entries">
                    <div class="log-entry">
                        <div>Breakfast: Oatmeal with Berries</div>
                        <div>320 kcal</div>
                    </div>
                    <div class="log-entry">
                        <div>Lunch: Grilled Chicken Salad</div>
                        <div>420 kcal</div>
                    </div>
                    <div class="log-entry">
                        <div>Snack: Greek Yogurt</div>
                        <div>150 kcal</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==== MODAL ==== -->
    <div id="generate-plan-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generating Meal Plan</h2>
                <button class="modal-close">×</button>
            </div>
            <div class="modal-body">
                <p>Generating your personalized meal plan based on your preferences and goals...</p>
                <div style="text-align:center;margin:2rem 0;">
                    <i class="fas fa-spinner fa-spin" style="font-size:3rem;color:#4CAF50;"></i>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        /* ==================== GLOBAL VARS ==================== */
        let currentPlan = null;
        const daysOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
        const mealOrder = ['breakfast', 'lunch', 'snack', 'dinner'];

        /* ==================== UI HELPERS ==================== */
        function showDayPlan(day) {
            document.querySelectorAll('.day-plan-container').forEach(c => c.classList.remove('active'));
            const sel = document.getElementById(`${day}-plan`);
            if (sel) sel.classList.add('active');
            document.querySelectorAll('.day-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.day === day);
            });
        }
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        /* ==================== PLAN RENDERING ==================== */
        function displaySimpleDietPlan(plan) {
            const container = document.getElementById('diet-plan-container');
            const display = document.getElementById('simple-plan-display');
            container.style.display = 'block';

            if (typeof plan === 'string') {
                display.innerHTML = `<pre class="simple-plan-content">${plan}</pre>`;
                return;
            }

            let html = '<div class="simple-plan-content">';
            // NEW consolidated format
            if (plan.breakfast_suggestions || plan.lunch_suggestions || plan.dinner_suggestions || plan.snack_suggestions) {
                const sections = [
                    { key: 'breakfast_suggestions', title: 'Breakfast Options' },
                    { key: 'lunch_suggestions', title: 'Lunch Options' },
                    { key: 'dinner_suggestions', title: 'Dinner Options' },
                    { key: 'snack_suggestions', title: 'Snack Options' }
                ];
                sections.forEach(s => {
                    if (!plan[s.key]) return;
                    html += `<h3>${s.title}</h3><ul class="meal-list">`;
                    plan[s.key].forEach(it => {
                        const name = it.name || it.meal_name || String(it);
                        const cal = it.calories ?? it.calorie ?? 'N/A';
                        const protein = it.protein ? `, Protein: ${it.protein}g` : '';
                        const carbs = it.carbs ? `, Carbs: ${it.carbs}g` : '';
                        const fat = it.fat ? `, Fat: ${it.fat}g` : '';
                        const desc = it.description ? ` - ${it.description}` : '';
                        html += `<li class="meal-item"><span class="meal-name">${name}</span><br><span class="meal-calories">${cal} kcal${protein}${carbs}${fat}${desc}</span></li>`;
                    });
                    html += '</ul>';
                });
            } else {
                // 7-day format with days in correct sequence
                const daysOrder = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                for (const day of daysOrder) {
                    if (!plan.hasOwnProperty(day)) continue;
                    html += `<h3>${day.charAt(0).toUpperCase() + day.slice(1)}'s Plan</h3><div class="day-meals">`;
                    for (const meal in plan[day]) {
                        const items = plan[day][meal];
                        if (!Array.isArray(items) || !items.length) continue;
                        html += `<h4>${meal.charAt(0).toUpperCase() + meal.slice(1)}</h4><ul class="meal-list">`;
                        items.forEach(it => {
                            const name = it.name || it.meal_name || String(it);
                            const cal = it.calories ?? it.calorie ?? 'N/A';
                            const protein = it.protein ? `, Protein: ${it.protein}g` : '';
                            const carbs = it.carbs ? `, Carbs: ${it.carbs}g` : '';
                            const fat = it.fat ? `, Fat: ${it.fat}g` : '';
                            const desc = it.description ? ` - ${it.description}` : '';
                            html += `<li class="meal-item"><span class="meal-name">${name}</span><br><span class="meal-calories">${cal} kcal${protein}${carbs}${fat}${desc}</span></li>`;
                        });
                        html += '</ul>';
                    }
                    html += '</div>';
                }
            }
            html += '</div>';
            display.innerHTML = html;
            updateNutritionValues(plan);
        }

        /* ==================== NUTRITION CALC ==================== */
        async function updateNutritionValues(plan) {
            const cards = document.querySelectorAll('.nutrient-card');

            // Load user's actual profile data to get real goals
            let userData = null;
            try {
                const response = await fetch('/api/current_user', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    userData = result.user;
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }

            // Use user's actual daily calorie target from profile, fallback to form value
            let dailyCalorieTarget = 2200; // Default
            if (userData && userData.daily_calories) {
                dailyCalorieTarget = Math.round(userData.daily_calories);
            } else {
                const calorieInput = document.getElementById('calories');
                if (calorieInput && calorieInput.value) {
                    dailyCalorieTarget = parseInt(calorieInput.value) || 2200;
                }
            }

            // Get user's specific nutrition goals (these should come from profile calculations)
            let calGoal = dailyCalorieTarget;
            let proGoal = 140; // Default protein goal
            let carbGoal = 300; // Default carb goal
            let fatGoal = 90; // Default fat goal

            // Update with user's actual goals if available
            if (userData) {
                // The actual goals should be calculated based on user's profile in backend
                // For now, using the default values but in a real app these would come from user profile
            }

            let totalCals = 0;
            let totalPro = 0;
            let totalCarb = 0;
            let totalFat = 0;

            // Function to add nutritional values from a single item
            function addItem(it) {
                if (it.calories) totalCals += +it.calories;
                if (it.protein) totalPro += +it.protein;
                if (it.carbs) totalCarb += +it.carbs;
                if (it.fat) totalFat += +it.fat;
            }

            // Handle consolidated format (suggestions)
            if (plan.breakfast_suggestions || plan.lunch_suggestions || plan.dinner_suggestions || plan.snack_suggestions) {
                if (plan.breakfast_suggestions) plan.breakfast_suggestions.forEach(addItem);
                if (plan.lunch_suggestions) plan.lunch_suggestions.forEach(addItem);
                if (plan.dinner_suggestions) plan.dinner_suggestions.forEach(addItem);
                if (plan.snack_suggestions) plan.snack_suggestions.forEach(addItem);
            } else {
                // Handle 7-day format - calculate values for the first day only (or average)
                // Let's calculate values for a single representative day
                let firstDayProcessed = false;
                for (const day in plan) {
                    if (!plan.hasOwnProperty(day) || firstDayProcessed) continue;

                    for (const meal in plan[day]) {
                        if (plan[day][meal] && Array.isArray(plan[day][meal])) {
                            plan[day][meal].forEach(item => {
                                if (item.calories) totalCals += +item.calories;
                                if (item.protein) totalPro += +item.protein;
                                if (item.carbs) totalCarb += +item.carbs;
                                if (item.fat) totalFat += +item.fat;
                            });
                        }
                    }
                    firstDayProcessed = true; // Only process first day to get daily values
                }
            }

            // Use actual values from plan if available, otherwise use estimates
            const estCals = totalCals > 0 ? totalCals : calGoal;
            const estPro = totalPro > 0 ? totalPro : Math.round(estCals * 0.15 / 4);
            const estCarb = totalCarb > 0 ? totalCarb : Math.round(estCals * 0.55 / 4);
            const estFat = totalFat > 0 ? totalFat : Math.round(estCals * 0.30 / 9);

            // Update UI
            cards[0].querySelector('.nutrient-value').textContent = estCals.toLocaleString();
            cards[1].querySelector('.nutrient-value').textContent = estPro + 'g';
            cards[2].querySelector('.nutrient-value').textContent = estCarb + 'g';
            cards[3].querySelector('.nutrient-value').textContent = estFat + 'g';

            // Update goal text to reflect user's actual targets
            cards[0].querySelector('.nutrient-label').textContent = 'Calories (Daily Goal: ' + calGoal.toLocaleString() + ')';
            cards[1].querySelector('.nutrient-label').textContent = 'Protein (Daily Goal: ' + proGoal + 'g)';
            cards[2].querySelector('.nutrient-label').textContent = 'Carbs (Daily Goal: ' + carbGoal + 'g)';
            cards[3].querySelector('.nutrient-label').textContent = 'Fat (Daily Goal: ' + fatGoal + 'g)';

            // Update progress bars based on user's actual goals
            const prog = cards[0].querySelectorAll('.progress');
            prog[0].style.width = Math.min(100, Math.round(estCals / calGoal * 100)) + '%';
            prog[1].style.width = Math.min(100, Math.round(estPro / proGoal * 100)) + '%';
            prog[2].style.width = Math.min(100, Math.round(estCarb / carbGoal * 100)) + '%';
            prog[3].style.width = Math.min(100, Math.round(estFat / fatGoal * 100)) + '%';
        }

        /* ==================== API CALL ==================== */
        async function generateNewMealPlan() {
            const goal = document.getElementById('goal').value;
            const cals = +document.getElementById('calories').value || 2200;
            const type = document.getElementById('diet-type').value;
            const allergies = document.getElementById('allergies')?.value || '';
            const med = document.getElementById('preferences')?.value || '';

            if (!goal || !cals || !type) { alert('Fill required fields'); return; }

            openModal('generate-plan-modal');

            try {
                const subRes = await fetch('/api/subscription/status', { credentials: 'include' });
                let isPremium = false;
                if (subRes.ok) { const d = await subRes.json(); isPremium = d.subscription_status === 'active'; }

                const body = {
                    goal,
                    calorie_target: cals,
                    diet_preference: type,
                    allergies: allergies ? allergies.split(',').map(s => s.trim()).filter(Boolean) : [],
                    medical_conditions: med ? med.split(',').map(s => s.trim()).filter(Boolean) : []
                };

                const res = await fetch('/api/diet-plan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });

                if (!res.ok) { const err = await res.json(); throw new Error(err.error || 'Server error'); }

                const data = await res.json();
                closeModal('generate-plan-modal');

                // ---- decide how to show ----
                if (data.plan_type?.includes('ai_generated') || data.original_response) {
                    displayWEBPlan(data.original_response || data.diet_plan?.full_plan || '');
                } else if (data.diet_plan && typeof data.diet_plan === 'object') {
                    currentPlan = data.diet_plan;
                    displaySimpleDietPlan(data.diet_plan);
                } else {
                    displaySimpleDietPlan('Unexpected response format.');
                }

                alert('Meal plan generated!');
            } catch (e) {
                closeModal('generate-plan-modal');
                alert('Error: ' + e.message);
                console.error(e);
            }
        }

        /* ==================== OTHER UI ACTIONS ==================== */
        function downloadPDF() {
            const el = document.querySelector('.meal-planner-container');
            const opt = {
                margin: 10,
                filename: 'diet-plan.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(el).save();
        }
        function saveCurrentPlan() { alert('Plan saved! (demo)'); }
        async function loadUserData() {
            try {
                const response = await fetch('/api/current_user', {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const result = await response.json();
                    const user = result.user;

                    if(user) {
                        // Update form defaults with user data if available
                        if(user.daily_calories) {
                            document.getElementById('calories').value = Math.round(user.daily_calories);
                        }

                        if(user.goal_type) {
                            document.getElementById('goal').value = user.goal_type;
                        }

                        // Update nutrition summary with user's calorie target and goals
                        if(user.daily_calories) {
                            const calorieValue = Math.round(user.daily_calories);
                            const nutrientCards = document.querySelectorAll('.nutrient-card');

                            if (nutrientCards.length >= 4) {
                                // Update Calories card (first card)
                                const calCard = nutrientCards[0];
                                calCard.querySelector('.nutrient-value').textContent = calorieValue.toLocaleString();
                                calCard.querySelector('.goal-cal').textContent = calorieValue.toLocaleString();
                                calCard.querySelector('.nutrient-label').textContent = `Calories (Daily Goal: ${calorieValue.toLocaleString()})`;

                                // Calculate macronutrient goals based on calorie target
                                const proteinGoal = Math.round((calorieValue * 0.15) / 4); // ~15% calories as protein
                                const carbGoal = Math.round((calorieValue * 0.55) / 4);   // ~55% as carbs
                                const fatGoal = Math.round((calorieValue * 0.30) / 9);     // ~30% as fat

                                // Update Protein card (second card)
                                const proCard = nutrientCards[1];
                                proCard.querySelector('.goal-pro').textContent = proteinGoal + 'g';
                                proCard.querySelector('.nutrient-label').textContent = `Protein (Daily Goal: ${proteinGoal}g)`;

                                // Update Carbs card (third card)
                                const carbCard = nutrientCards[2];
                                carbCard.querySelector('.goal-carb').textContent = carbGoal + 'g';
                                carbCard.querySelector('.nutrient-label').textContent = `Carbs (Daily Goal: ${carbGoal}g)`;

                                // Update Fat card (fourth card)
                                const fatCard = nutrientCards[3];
                                fatCard.querySelector('.goal-fat').textContent = fatGoal + 'g';
                                fatCard.querySelector('.nutrient-label').textContent = `Fat (Daily Goal: ${fatGoal}g)`;

                                // Update initial values to match user goals
                                proCard.querySelector('.nutrient-value').textContent = Math.round(proteinGoal * 1.07) + 'g'; // 107% of goal as example
                                carbCard.querySelector('.nutrient-value').textContent = Math.round(carbGoal * 0.93) + 'g';  // 93% of goal as example
                                fatCard.querySelector('.nutrient-value').textContent = Math.round(fatGoal * 0.94) + 'g';    // 94% of goal as example

                                // Update progress bars based on user's calorie target
                                const progressBars = document.querySelectorAll('.progress');
                                if (progressBars.length >= 4) {
                                    const caloriePercent = Math.min(100, Math.round((calorieValue / calorieValue) * 100));
                                    progressBars[0].style.width = caloriePercent + '%';

                                    const proteinPercent = Math.min(150, Math.round((proteinGoal * 1.07) / proteinGoal * 100));
                                    progressBars[1].style.width = proteinPercent + '%';

                                    const carbsPercent = Math.min(100, Math.round((carbGoal * 0.93) / carbGoal * 100));
                                    progressBars[2].style.width = carbsPercent + '%';

                                    const fatPercent = Math.min(100, Math.round((fatGoal * 0.94) / fatGoal * 100));
                                    progressBars[3].style.width = fatPercent + '%';
                                }
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        async function loadSubscriptionStatus() {
            try {
                const r = await fetch('/api/subscription/status', { credentials: 'include' });
                if (!r.ok) throw '';
                const d = await r.json();
                const el = document.getElementById('current-subscription');
                if (d.subscription_status === 'active') {
                    el.className = 'subscription-status status-active';
                    el.textContent = `Premium Active – ends ${new Date(d.subscription_end_date).toLocaleDateString()}`;
                    document.getElementById('premiumFeatures').style.display = 'flex';
                    document.getElementById('generate-plan-btn-form').innerHTML = '<i class="fas fa-magic"></i> Generate AI Diet Plan';
                } else {
                    el.className = 'subscription-status status-inactive';
                    el.textContent = 'Free Plan – upgrade for AI plans';
                    document.getElementById('premiumFeatures').style.display = 'none';
                    document.getElementById('generate-plan-btn-form').innerHTML = '<i class="fas fa-magic"></i> Generate Basic Diet Plan';
                }
            } catch { }
        }

        /* ==================== INIT ==================== */
        document.addEventListener('DOMContentLoaded', () => {

            // generate day containers (once)
            const daysContainer = document.createElement('div');
            daysContainer.id = 'days-container';
            document.querySelector('.meal-planner-container').insertBefore(daysContainer, document.getElementById('diet-plan-container'));

            daysOrder.forEach(d => {
                const tab = `<div class="day-tab" data-day="${d}">${d.charAt(0).toUpperCase() + d.slice(1)}</div>`;
                document.querySelector('.days-tabs')?.insertAdjacentHTML('beforeend', tab);

                const planDiv = `<div id="${d}-plan" class="day-plan-container"><div id="${d}-meals" class="meals-container"></div></div>`;
                daysContainer.insertAdjacentHTML('beforeend', planDiv);
            });

            loadUserData();
            loadSubscriptionStatus();

            // buttons
            document.getElementById('generate-plan-btn-form').addEventListener('click', generateNewMealPlan);
            document.getElementById('save-plan-btn').addEventListener('click', saveCurrentPlan);
            document.getElementById('download-pdf-btn').addEventListener('click', downloadPDF);
            document.getElementById('log-meal-btn').addEventListener('click', () => alert('Log meal form would open here'));

            // day tabs
            document.querySelectorAll('.day-tab').forEach(t => t.addEventListener('click', () => showDayPlan(t.dataset.day)));

            // modal close
            document.querySelectorAll('.modal-close,.modal').forEach(el => el.addEventListener('click', e => {
                if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) closeModal('generate-plan-modal');
            }));

            showDayPlan('monday');
        });
    </script>
</body>

</html>